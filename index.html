<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Rutas Solidarias IA - Mapa y Rutas</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0 16px 24px;
      background: #f4f7fb;
    }
    header {
      padding: 16px 0 8px;
    }
    h1 {
      margin: 0;
      color: #0b4f8a;
    }
    small {
      color: #555;
    }
    #map {
      width: 100%;
      height: 420px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      margin-top: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      font-size: 13px;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 8px;
    }
    th {
      background: #e6f0fa;
      text-align: left;
    }
    tr:nth-child(even) {
      background: #fafbff;
    }
    .panel {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      background: #0b4f8a;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:hover {
      background: #0d629f;
    }
    .badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: #fff;
    }
    .prio-alta  { background: #d72638; }
    .prio-media { background: #f4a261; }
    .prio-baja  { background: #2a9d8f; }
    #resumen {
      font-size: 13px;
      color: #333;
    }
  </style>
</head>
<body>
  <header>
    <h1>Rutas Solidarias IA</h1>
    <small>
      Logística solidaria y ayuda humanitaria en Ecuador – demo con geolocalización y rutas de camiones.
    </small>
  </header>

  <div id="map"></div>

  <div class="panel">
    <button class="btn" onclick="calcularPrioridadesYRutas()">
      Calcular prioridades y rutas de camiones
    </button>
    <div id="resumen"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Comunidad</th>
        <th>Provincia</th>
        <th>Personas afectadas</th>
        <th>Nivel de afectación (1–5)</th>
        <th>Acceso (horas)</th>
        <th>Necesidad vital</th>
        <th>Prioridad</th>
      </tr>
    </thead>
    <tbody id="tbody-comunidades"></tbody>
  </table>

  <!-- SCRIPT PRINCIPAL (no uses type="module") -->
  <script>
    // --- Comunidades afectadas por el terremoto de Manabí 2016 ---
    const comunidades = [
      {
        nombre: "Barrio Tarqui - Manta",
        direccion: "Barrio Tarqui, Manta, Manabí, Ecuador",
        provincia: "Manabí",
        personas: 15000,
        nivelAfectacion: 5,
        accesoHoras: 0.5,
        necesidadVital: 3
      },
      {
        nombre: "Centro de Portoviejo",
        direccion: "Parque Vicente Amador Flor, Portoviejo, Manabí, Ecuador",
        provincia: "Manabí",
        personas: 12000,
        nivelAfectacion: 4,
        accesoHoras: 0.8,
        necesidadVital: 3
      },
      {
        nombre: "Pedernales urbano",
        direccion: "Parque Central de Pedernales, Manabí, Ecuador",
        provincia: "Manabí",
        personas: 8000,
        nivelAfectacion: 5,
        accesoHoras: 3.5,
        necesidadVital: 3
      },
      {
        nombre: "Jama",
        direccion: "Parque Central de Jama, Manabí, Ecuador",
        provincia: "Manabí",
        personas: 3000,
        nivelAfectacion: 4,
        accesoHoras: 4.0,
        necesidadVital: 2
      },
      {
        nombre: "Canoa",
        direccion: "Malecón de Canoa, Manabí, Ecuador",
        provincia: "Manabí",
        personas: 2500,
        nivelAfectacion: 4,
        accesoHoras: 3.8,
        necesidadVital: 2
      }
    ];

    let map;
    let directionsService;
    let directionsRenderers = [];

    function prioridadBadge(score) {
      if (score >= 0.7) return '<span class="badge prio-alta">Alta</span>';
      if (score >= 0.45) return '<span class="badge prio-media">Media</span>';
      return '<span class="badge prio-baja">Baja</span>';
    }

    function renderTabla() {
      const tbody = document.getElementById("tbody-comunidades");
      tbody.innerHTML = "";
      comunidades.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.nombre}</td>
          <td>${c.provincia}</td>
          <td>${c.personas}</td>
          <td>${c.nivelAfectacion}</td>
          <td>${c.accesoHoras.toFixed(1)}</td>
          <td>${c.necesidadVital === 3 ? "Muy alta" : (c.necesidadVital === 2 ? "Media" : "Baja")}</td>
          <td>${typeof c.score === "number" ? prioridadBadge(c.score) + " " + c.score.toFixed(2) : "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Esta función DEBE ser global para que Maps la llame
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -0.6, lng: -80.4 }, // Manabí
        zoom: 8
      });

      directionsService = new google.maps.DirectionsService();
      renderTabla();
    }

    function limpiarRutas() {
      directionsRenderers.forEach(r => r.setMap(null));
      directionsRenderers = [];
    }

    function calcularPrioridadesYRutas() {
      limpiarRutas();

      const maxPersonas = Math.max(...comunidades.map(c => c.personas));
      const maxAcceso   = Math.max(...comunidades.map(c => c.accesoHoras));

      comunidades.forEach(c => {
        const personasNorm   = c.personas / maxPersonas;
        const afectacionNorm = c.nivelAfectacion / 5;
        const accesoNorm     = c.accesoHoras / maxAcceso;
        const necesidadNorm  = c.necesidadVital / 3;

        const score =
          0.35 * afectacionNorm +
          0.30 * personasNorm +
          0.25 * necesidadNorm +
          0.10 * (1 - accesoNorm);

        c.score = score;
      });

      comunidades.sort((a, b) => b.score - a.score);
      renderTabla();

      const camiones = [
        {
          nombre: "Camión 1",
          origen: "Manta, Manabí, Ecuador",
          color: "#d72638",
          destinos: []
        },
        {
          nombre: "Camión 2",
          origen: "Portoviejo, Manabí, Ecuador",
          color: "#2a9d8f",
          destinos: []
        },
        {
          nombre: "Camión 3",
          origen: "Pedernales, Manabí, Ecuador",
          color: "#f4a261",
          destinos: []
        }
      ];

      // Distribución simple por prioridad (round-robin)
      comunidades.forEach((c, idx) => {
        const idxCamion = idx % camiones.length;
        camiones[idxCamion].destinos.push(c);
      });

      const resumenDiv = document.getElementById("resumen");
      let resumenHTML = "";

      camiones.forEach(camion => {
        if (camion.destinos.length === 0) return;

        const destinoFinal = camion.destinos[camion.destinos.length - 1].direccion;
        const waypoints = camion.destinos.slice(0, -1).map(c => ({
          location: c.direccion,
          stopover: true
        }));

        const request = {
          origin: camion.origen,
          destination: destinoFinal,
          waypoints: waypoints,
          travelMode: google.maps.TravelMode.DRIVING,
          optimizeWaypoints: true
        };

        const renderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: false,
          preserveViewport: true,
          polylineOptions: {
            strokeColor: camion.color,
            strokeOpacity: 0.9,
            strokeWeight: 4
          }
        });

        directionsService.route(request, (result, status) => {
          if (status === google.maps.DirectionsStatus.OK) {
            renderer.setDirections(result);
            directionsRenderers.push(renderer);

            const personasCubr = camion.destinos
              .reduce((acc, c) => acc + c.personas, 0);

            resumenHTML += `<div><strong>${camion.nombre}</strong>: atiende ${camion.destinos.length} comunidades (~${personasCubr} personas).</div>`;
            resumenDiv.innerHTML = resumenHTML;
          } else {
            console.warn("No se pudo calcular la ruta para", camion.nombre, status);
          }
        });
      });
    }
  </script>

  <!-- Cambia TU_API_KEY_AQUI por tu key real -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDBv0_UNjKplm2PhTl8ZTjzT5Lab2ogj7E&callback=initMap">
  </script>
</body>
</html>
